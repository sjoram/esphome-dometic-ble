substitutions:
  name: camper1-dometicac
  project: camper1.dometicac
  device_description: "Control a Dometic AirCon over Ble"
  friendly_name: DometicAC

#  mac_address: 

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  comment: ${device_description}
  min_version: 2026.2.0
  name_add_mac_suffix: false
  project:
    name: ${project}
    version: "1.0.0"
  on_boot:
    priority: -100
    then:
      - delay: 10s
      - mqtt.publish:
          topic: homeassistant/climate/dometic_ac/config
          retain: true
          payload: |-
            {
              "name": "Dometic AC",
              "unique_id": "dometic_ac_climate",
              "availability_topic": "camper/dometic/status",
              "payload_available": "online",
              "payload_not_available": "offline",
              "mode_state_topic": "camper/dometic/mode",
              "mode_command_topic": "camper/dometic/set_mode",
              "temperature_state_topic": "camper/dometic/target_temp",
              "temperature_command_topic": "camper/dometic/set_temp",
              "current_temperature_topic": "camper/dometic/current_temp",
              "fan_mode_state_topic": "camper/dometic/fan",
              "fan_mode_command_topic": "camper/dometic/set_fan",
              "preset_modes": ["sleep"],
              "preset_mode_state_topic": "camper/dometic/preset",
              "preset_mode_command_topic": "camper/dometic/set_preset",
              "temperature_unit": "C",
              "modes": ["off","cool","heat","fan_only","auto","dry"],
              "fan_modes": ["low","medium","high","turbo","auto"],
              "min_temp": 16,
              "max_temp": 30,
              "temp_step": 0.5,
              "device": {
                "identifiers": ["dometic_ac"],
                "name": "Dometic AC",
                "manufacturer": "Dometic"
              }
            }
      - mqtt.publish:
          topic: camper/dometic/power
          payload: "ON"
          retain: true

      - mqtt.publish:
          topic: homeassistant/climate/dometic_ac/config
          retain: true
          payload: |-
            { ... your existing JSON ... }

      # âœ… Publish retained state snapshot
      - mqtt.publish:
          topic: camper/dometic/mode
          payload: !lambda |-
            if (id(operational_mode).state == 0) return "cool";
            if (id(operational_mode).state == 1) return "heat";
            if (id(operational_mode).state == 2) return "fan_only";
            if (id(operational_mode).state == 3) return "auto";
            if (id(operational_mode).state == 4) return "dry";
            return "off";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/fan
          payload: !lambda |-
            if (id(fan_mode).state == 0) return "low";
            if (id(fan_mode).state == 1) return "medium";
            if (id(fan_mode).state == 2) return "high";
            if (id(fan_mode).state == 3) return "turbo";
            if (id(fan_mode).state == 5) return "auto";
            return "auto";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/preset
          payload: !lambda |-
            if (id(sleep_mode).state == 1) return "sleep";
            return "none";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/current_temp
          payload: !lambda 'return to_string(id(actual_temp).state);'
          retain: true

      - mqtt.publish:
          topic: camper/dometic/target_temp
          payload: !lambda 'return to_string(id(command_temp).state);'
          retain: true



# Also may use ID??? framework here
esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging - Can also use VERBOSE or VERY_VERBOSE for more details
logger:
  level: DEBUG

# Enable Home Assistant API
api:

mqtt:
  broker: 192.168.000.000   # <-- CHANGE to your broker IP
  username: !secret mqtt_user
  password: !secret mqtt_password
  discovery: true
  discovery_prefix: homeassistant

  birth_message:
    topic: camper/dometic/status
    payload: online

  will_message:
    topic: camper/dometic/status
    payload: offline

  on_connect:
    then:
      - mqtt.publish:
          topic: homeassistant/climate/dometic_ac/config
          retain: true
          payload: |-
            {
              "name": "Dometic AC",
              "unique_id": "dometic_ac_climate",
              "availability_topic": "camper/dometic/status",
              "payload_available": "online",
              "payload_not_available": "offline",

              "mode_state_topic": "camper/dometic/mode",
              "mode_command_topic": "camper/dometic/set_mode",

              "temperature_state_topic": "camper/dometic/target_temp",
              "temperature_command_topic": "camper/dometic/set_temp",

              "current_temperature_topic": "camper/dometic/current_temp",

              "fan_mode_state_topic": "camper/dometic/fan",
              "fan_mode_command_topic": "camper/dometic/set_fan",

              "preset_modes": ["sleep"],
              "preset_mode_state_topic": "camper/dometic/preset",
              "preset_mode_command_topic": "camper/dometic/set_preset",

              "temperature_unit": "C",

              "modes": ["off","cool","heat","fan_only","auto","dry"],
              "fan_modes": ["low","medium","high","turbo","auto"],

              "min_temp": 16,
              "max_temp": 30,
              "temp_step": 0.5,

              "device": {
                "identifiers": ["dometic_ac"],
                "name": "Dometic AC",
                "manufacturer": "Dometic"
              }
            }

      - mqtt.publish:
          topic: homeassistant/climate/dometic_ac/config
          retain: true
          payload: |-
            { ... your existing JSON ... }

      # âœ… Publish retained state snapshot
      - mqtt.publish:
          topic: camper/dometic/mode
          payload: !lambda |-
            if (id(operational_mode).state == 0) return "cool";
            if (id(operational_mode).state == 1) return "heat";
            if (id(operational_mode).state == 2) return "fan_only";
            if (id(operational_mode).state == 3) return "auto";
            if (id(operational_mode).state == 4) return "dry";
            return "off";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/fan
          payload: !lambda |-
            if (id(fan_mode).state == 0) return "low";
            if (id(fan_mode).state == 1) return "medium";
            if (id(fan_mode).state == 2) return "high";
            if (id(fan_mode).state == 3) return "turbo";
            if (id(fan_mode).state == 5) return "auto";
            return "auto";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/preset
          payload: !lambda |-
            if (id(sleep_mode).state == 1) return "sleep";
            return "none";
          retain: true

      - mqtt.publish:
          topic: camper/dometic/current_temp
          payload: !lambda 'return to_string(id(actual_temp).state);'
          retain: true

      - mqtt.publish:
          topic: camper/dometic/target_temp
          payload: !lambda 'return to_string(id(command_temp).state);'
          retain: true


  on_message:
    - topic: camper/dometic/set_preset
      then:

        # If user selects SLEEP
        - if:
            condition:
              lambda: 'return x == "sleep";'
            then:
              # Only allow in Cool(0) or Heat(1)
              - if:
                  condition:
                    lambda: |-
                      return (id(operational_mode).state == 0 ||
                              id(operational_mode).state == 1);
                  then:
                    # âœ… Valid â†’ send BLE + publish sleep
                    - ble_client.ble_write:
                        id: MyDometic
                        service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                        characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                        value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]

                    - mqtt.publish:
                        topic: camper/dometic/preset
                        payload: "sleep"
                        retain: true

                  else:
                    # âŒ Invalid â†’ immediately force NONE
                    - logger.log: "Sleep not valid in this mode"
                    - mqtt.publish:
                        topic: camper/dometic/preset
                        payload: "none"
                        retain: true

        # If user selects NONE
        - if:
            condition:
              lambda: 'return x == "none";'
            then:
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

              - mqtt.publish:
                  topic: camper/dometic/preset
                  payload: "none"
                  retain: true


    - topic: camper/dometic/set_temp
      then:
        - number.set:
            id: target_temp
            value: !lambda 'return atof(x.c_str());'

    - topic: camper/dometic/set_mode
      then:
        - if:
            condition:
              lambda: 'return x == "off";'
            then:
              # ðŸ”´ POWER OFF
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x01, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

              # ðŸ”´ ALSO CLEAR SLEEP
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

              - mqtt.publish:
                  topic: camper/dometic/mode
                  payload: "off"
                  retain: true

              - mqtt.publish:
                  topic: camper/dometic/preset
                  payload: "none"
                  retain: true

            else:
              # ðŸ”µ POWER ON FIRST
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x01, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]

              - mqtt.publish:
                  topic: camper/dometic/mode
                  payload: !lambda 'return x;'
                  retain: true

              - lambda: |-
                  auto call = id(function_selection).make_call();
                  if (x == "cool") call.set_option("Cooling");
                  else if (x == "heat") call.set_option("Heating");
                  else if (x == "fan_only") call.set_option("Ventilation");
                  else if (x == "auto") call.set_option("Auto");
                  else if (x == "dry") call.set_option("Dry");
                  call.perform();

              # ðŸ”µ If not cool or heat â†’ clear sleep
              - if:
                  condition:
                    lambda: 'return x != "cool" && x != "heat";'
                  then:
                    - ble_client.ble_write:
                        id: MyDometic
                        service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                        characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                        value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

                    - mqtt.publish:
                        topic: camper/dometic/preset
                        payload: "none"
                        retain: true


    - topic: camper/dometic/set_fan
      then:
        - mqtt.publish:
            topic: camper/dometic/fan
            payload: !lambda 'return x;'           
        - lambda: |-
            auto call = id(fan_mode_selection).make_call();
            if (x == "low") call.set_option("Low");
            else if (x == "medium") call.set_option("Medium");
            else if (x == "high") call.set_option("High");
            else if (x == "turbo") call.set_option("Turbo");
            else if (x == "auto") call.set_option("Auto");
            call.perform();

    - topic: camper/dometic/set_power
      then:
        - mqtt.publish:
            topic: camper/dometic/power
            payload: !lambda 'return x;'
            retain: true

        - if:
            condition:
              lambda: 'return x == "OFF";'
            then:
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x01, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]
            else:
              - ble_client.ble_write:
                  id: MyDometic
                  service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                  characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                  value: [0x11, 0x01, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]



# Allow Over-The-Air updates
ota:
- platform: esphome

# Connect to the WiFi network
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: on

  manual_ip:
    static_ip: 192.168.000.000
    gateway: 192.168.000.000
    subnet: 255.255.255.0

  # Set up an Access Point
  ap: {}  
 
# In combination with the `ap` this allows the user
# to provision wifi credentials to the device via WiFi AP.
captive_portal:

# To have a "next url" for improv serial
web_server:

# Sets up Bluetooth LE (Only on ESP32) to allow the user
# to provision wifi credentials to the device.
esp32_improv:
  authorizer: none


# ------------------------------------------
# From here is the individual device control

esp32_ble_tracker:
  on_ble_service_data_advertise:
    - mac_address: "mac_address"     # Enter your Dometic Unit mac address here
      service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
      then:

ble_client:
  - id: MyDometic
    mac_address: "94:E6:86:A7:56:12"
    auto_connect: true
    on_connect:
      then:
        - logger.log: "Connected to Dometic - waiting before poll"
        - delay: 5s
        - switch.turn_on: poll_switch

binary_sensor:
  - platform: status
    name: "Dometic Status"

number:
  - platform: template
    name: "Target AC Temp"
    id: target_temp
    min_value: 16.0
    max_value: 30.0
    step: 0.5
    unit_of_measurement: "Â°C"
    set_action:
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          value: !lambda |-
            int temp = int(x * 1000);  // convert Â°C to device value
            return {0x11, 0x04, 0x00, 0x02, 0x01, 
                    uint8_t(temp & 0xFF), 
                    uint8_t((temp >> 8) & 0xFF), 
                    0x00, 0x00};

  - platform: template
    name: "Light Brightness"
    id: light_brightness
    min_value: 0
    max_value: 100
    step: 1
    set_action:
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          value: !lambda |-
            return std::vector<uint8_t>{
              0x11, 0x06, 0x00, 0x02, 0x01,
              (uint8_t)x,
              0x00, 0x00, 0x00
            };

light:
  - platform: monochromatic
    name: "Dometic Light"
    id: dometic_light
    restore_mode: RESTORE_DEFAULT_OFF
    output: dometic_light_output
    default_transition_length: 0s
    gamma_correct: 1.0

output:
  - platform: template
    id: dometic_light_output
    type: float
    write_action:
      - lambda: |-
          ESP_LOGI("LIGHT", "Brightness state = %.3f", state);
      # OFF
      - if:
          condition:
            lambda: 'return state < 0.015;'
          then:
            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x05, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

      # ON + 50% or 100%
      - if:
          condition:
            lambda: 'return state >= 0.015;'
          then:
            - lambda: |-
                ESP_LOGI("LIGHT", "Off");
            # Always turn ON first
            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x05, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]

            # Snap brightness
            - if:
                condition:
                  lambda: 'return state < 0.6;'
                then:
                  - lambda: |-
                      ESP_LOGI("LIGHT", "50%");
                  - ble_client.ble_write:
                      id: MyDometic
                      service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                      characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                      value: [0x11, 0x06, 0x00, 0x02, 0x01, 0x32, 0x00, 0x00, 0x00]
                else:
                  - lambda: |-
                      ESP_LOGI("LIGHT", "100%");                  
                  - ble_client.ble_write:
                      id: MyDometic
                      service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                      characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                      value: [0x11, 0x06, 0x00, 0x02, 0x01, 0x64, 0x00, 0x00, 0x00]


select:
  - platform: template
    id: fan_mode_selection
    internal: true
    options:
     - "Low"
     - "Medium"
     - "High"
     - "Auto"
     - "Turbo"
    initial_option: "Auto"
    optimistic: true
    set_action:
      - lambda: |-
          uint8_t val = 0;
          if (x == "Low") val = 0;
          else if (x == "Medium") val = 1;
          else if (x == "High") val = 2;
          else if (x == "Turbo") val = 3;
          else if (x == "Auto") val = 5;
          id(fan_mode).publish_state(val);

      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          value: !lambda |-
            return std::vector<uint8_t>{0x11, 0x02, 0x00, 0x02, 0x01, (uint8_t)id(fan_mode).state, 0x00, 0x00, 0x00};

  - platform: template
    id: function_selection
    internal: true
    options:
     - "Cooling"
     - "Heating"
     - "Ventilation"
     - "Auto"
     - "Dry"
    initial_option: "Auto"
    optimistic: true
    set_action:
      - lambda: |-
          uint8_t val = 0;
          if (x == "Cooling") val = 0;
          else if (x == "Heating") val = 1;
          else if (x == "Ventilation") val = 2;
          else if (x == "Auto") val = 3;
          else if (x == "Dry") val = 4;
          id(operational_mode).publish_state(val);

      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          value: !lambda |-
            return std::vector<uint8_t>{0x11, 0x03, 0x00, 0x02, 0x01, (uint8_t)id(operational_mode).state, 0x00, 0x00, 0x00};

  - platform: template
    name: "Dometic Light"
    id: dometic_light_select
    options:
      - "Off"
      - "50%"
      - "100%"
    optimistic: true
    set_action:

      - if:
          condition:
            lambda: 'return x == "Off";'
          then:
            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x05, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]

      - if:
          condition:
            lambda: 'return x == "50%";'
          then:
            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x05, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]

            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x06, 0x00, 0x02, 0x01, 0x32, 0x00, 0x00, 0x00]

      - if:
          condition:
            lambda: 'return x == "100%";'
          then:
            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x05, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]

            - ble_client.ble_write:
                id: MyDometic
                service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
                characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
                value: [0x11, 0x06, 0x00, 0x02, 0x01, 0x64, 0x00, 0x00, 0x00]

switch:
  - platform: template
    name: "Sleep"
    lambda: |-
        if(id(sleep_mode).state == 1.0) {
          return true;
        } else {
          return false;
        }
    turn_on_action:
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00]
    turn_off_action:
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x11, 0x1b, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00]


# Poll all the registers

  - platform: template
    name: "Poll"
    id: poll_switch
    turn_on_action:
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x01, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x03, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x02, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x1c, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x0a, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x04, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x1b, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x05, 0x00, 0x02, 0x01]
      - ble_client.ble_write:
          id: MyDometic
          service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
          characteristic_uuid: "537A0401-0995-481F-926C-1604E23FD515"
          # List of bytes to write.
          value: [0x12, 0x06, 0x00, 0x02, 0x01]

globals:
  - id: power_state
    type: bool
    restore_value: no
    initial_value: 'true'

sensor:
  - platform: template
    name: "Operational Mode"
    id: operational_mode
    on_value:
      - mqtt.publish:
          topic: camper/dometic/mode
          retain: true          
          payload: !lambda |-
            if (x == 0) return "cool";
            if (x == 1) return "heat";
            if (x == 2) return "fan_only";
            if (x == 3) return "auto";
            if (x == 4) return "dry";
            return "off";

  - platform: template
    name: "Fan Mode"
    id: fan_mode
    on_value:
      - mqtt.publish:
          topic: camper/dometic/fan
          retain: true          
          payload: !lambda |-
            if (x == 0) return "low";
            if (x == 1) return "medium";
            if (x == 2) return "high";
            if (x == 3) return "turbo";
            if (x == 5) return "auto";
            return "auto";

  - platform: template
    name: "Actual_Temp"
    id: actual_temp
    unit_of_measurement: 'Â°C'
    state_class: measurement
    icon: mdi:thermometer
    on_value:
      - mqtt.publish:
          topic: camper/dometic/current_temp
          retain: true
          payload: !lambda 'return to_string(x);'

  - platform: template
    name: "Command_Temp"
    id: command_temp
    unit_of_measurement: 'Â°C'
    state_class: measurement
    icon: mdi:thermometer
    on_value:
      - mqtt.publish:
          topic: camper/dometic/target_temp
          retain: true
          payload: !lambda 'return to_string(x);'

  - platform: template
    name: "Light Mode"
    id: light_mode

  - platform: template
    name: "Sleep Mode"
    id: sleep_mode
    on_value:
      - mqtt.publish:
          topic: camper/dometic/preset
          retain: true
          payload: !lambda |-
            if (x == 1) return "sleep";
            return "none";
    
  - platform: ble_client
    type: characteristic
    ble_client_id: MyDometic
    name: "Response2"
    service_uuid: "537A0400-0995-481F-926C-1604E23FD515"
    characteristic_uuid: "537A0402-0995-481F-926C-1604E23FD515"
    notify: true
    # 10:06:00:02:01:64:00:00:00
    lambda: |-
      ESP_LOGI("BLE", "Raw notification: %s", format_hex_pretty(x.data(), x.size()).c_str());
      if(x.size() > 5) {
        ESP_LOGI("BLE", "Register 0x%02X", x[1]);
        if (x[1] == 5) {
          bool on = (x[5] == 1);

          if (id(dometic_light).current_values.is_on() == on) {
            ESP_LOGI("BLE", "Power unchanged, skipping");
            return x[5];
          }

          ESP_LOGI("BLE", "Updating light power = %d", on);

          auto call = id(dometic_light).make_call();
          call.set_state(on);
          call.perform();

          return x[5];
        }
        if (x[1] == 6) {
          uint8_t brightness = x[5];

          float normalized = 0.0;
          if (brightness == 0x32)
            normalized = 0.5;
          else if (brightness == 0x64)
            normalized = 1.0;

          float current = id(dometic_light).current_values.get_brightness();

          if (fabs(current - normalized) < 0.01) {
            ESP_LOGI("BLE", "Brightness unchanged, skipping");
            return brightness;
          }

          ESP_LOGI("BLE", "Updating brightness to %.2f", normalized);

          auto call = id(dometic_light).make_call();
          call.set_brightness(normalized);
          call.perform();

          return brightness;
        }
        if(x[1] == 1) {   // Power register
          id(power_state) = (x[5] == 1);
          if(!id(power_state)) {
            mqtt::global_mqtt_client->publish("camper/dometic/mode", "off", true);
          }
          return (float)x[5];
        }
        if(x[1] == 3) {
          if(!id(power_state)) {
            // Ignore mode updates when powered off
            return (float)x[5];
          }
          id(operational_mode).publish_state((float)x[5]);
          return (float)x[5];
        }
        if(x[1] == 2) {
          id(fan_mode).publish_state((int)x[5]);
          return (float)x[5];
        }
        if(x[1] == 27) {
          id(sleep_mode).publish_state((float)x[5]);
          return (float)x[5];
        }
        if(x[1] == 4) {
          id(command_temp).publish_state((float)((int16_t)(x[5] | (x[6] << 8)))/1000); 
          return (float)((int16_t)(x[5] | (x[6] << 8)));
        }
        if(x[1] == 10) {
          id(actual_temp).publish_state((float)((int16_t)(x[5] | (x[6] << 8)))/1000); 
          return (float)((int16_t)(x[5] | (x[6] << 8)));
        }
        ESP_LOGW("BLE", "Unhandled register 0x%02X value=%d", x[1], x[5]);
      }
      ESP_LOGW("BLE", "Response too short. Skipped...");
      return {};    

# ------------------------------
# Automatic Poll Interval
# ------------------------------
interval:
  - interval: 30s   # poll every 30 seconds
    then:
      - switch.turn_on: poll_switch



